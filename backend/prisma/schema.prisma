generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum BookStatus {
  AVAILABLE
  BORROWED
  RESERVED
  MAINTENANCE
  LOST
}

enum BorrowingStatus {
  ACTIVE
  RETURNED
  OVERDUE
  LOST
}

enum ReservationStatus {
  PENDING
  READY
  CANCELLED
  FULFILLED
  EXPIRED
}

enum FineStatus {
  UNPAID
  PARTIAL
  PAID
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  name         String
  role         Role     @default(STUDENT)
  studentId    String?  @unique
  teacherId    String?  @unique
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  borrowings   Borrowing[]
  reservations Reservation[]
  fines        Fine[]

  @@map("users")
}

model Book {
  id              String     @id @default(uuid())
  isbn            String     @unique
  title           String
  author          String
  publisher       String
  publishedYear   Int
  category        String
  description     String?
  coverImage      String?
  location        String?
  totalCopies     Int        @default(1)
  availableCopies Int        @default(1)
  status          BookStatus @default(AVAILABLE)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  borrowings      Borrowing[]
  reservations    Reservation[]

  @@index([category])
  @@index([title])
  @@map("books")
}

model Borrowing {
  id           String          @id @default(uuid())
  userId       String
  bookId       String
  borrowedAt   DateTime        @default(now())
  dueDate      DateTime
  returnedAt   DateTime?
  status       BorrowingStatus @default(ACTIVE)
  renewedCount Int             @default(0)
  maxRenewals  Int             @default(2)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  user         User            @relation(fields: [userId], references: [id])
  book         Book            @relation(fields: [bookId], references: [id])
  fine         Fine?

  @@index([userId])
  @@index([bookId])
  @@index([status])
  @@map("borrowings")
}

model Reservation {
  id          String            @id @default(uuid())
  userId      String
  bookId      String
  status      ReservationStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  expiresAt   DateTime
  notifiedAt  DateTime?
  fulfilledAt DateTime?

  user        User              @relation(fields: [userId], references: [id])
  book        Book              @relation(fields: [bookId], references: [id])

  @@index([userId])
  @@index([bookId])
  @@index([status])
  @@map("reservations")
}

model Fine {
  id          String    @id @default(uuid())
  borrowingId String    @unique
  userId      String
  amount      Decimal   @db.Decimal(10, 2)
  reason      String
  status      FineStatus @default(UNPAID)
  paidAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  borrowing   Borrowing @relation(fields: [borrowingId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@map("fines")
}
